services:
  abuseipdb-bouncer:
    build:
      context: ./scripts
      dockerfile: Dockerfile
    image: abuseipdb-bouncer:local
    pull_policy: never
    container_name: abuseipdb-bouncer
    restart: always
    depends_on:
      crowdsec:
        condition: service_healthy
    extra_hosts:
      # Set this to your CrowdSec LAPI hostname and IP
      # Example: - "crowdsec.local:172.18.0.14"
      - "YOUR_LAPI_HOST:YOUR_LAPI_IP"
    entrypoint: ["/bin/sh", "/bouncer-entrypoint.sh"]
    environment:
      - CROWDSEC_ABUSEIPDB_BOUNCER_KEY=${CROWDSEC_ABUSEIPDB_BOUNCER_KEY}
      - ABUSEIPDB_API_KEY=${ABUSEIPDB_API_KEY}
      - ABUSEIPDB_DAILY_LIMIT=${ABUSEIPDB_DAILY_LIMIT:-1000}
      - ABUSEIPDB_PRECHECK=${ABUSEIPDB_PRECHECK:-false}
      - ABUSEIPDB_MIN_DURATION=${ABUSEIPDB_MIN_DURATION:-0}
      - LOG_LEVEL=${LOG_LEVEL:-info}
    volumes:
      - ./config/crowdsec-custom-bouncer.yaml.tmpl:/crowdsec-custom-bouncer.yaml.tmpl:ro
      - ./scripts/bouncer-entrypoint.sh:/bouncer-entrypoint.sh:ro
      - ./scripts/crowdsec-abuseipdb-reporter.sh:/abuseipdb-reporter.sh:ro
      - abuseipdb-state:/tmp/cs-abuseipdb
    healthcheck:
      test: ["CMD", "pgrep", "-f", "crowdsec-custom-bouncer"]
      interval: 30s
      timeout: 5s
      retries: 3
      start_period: 10s
    networks:
      # Set this to your CrowdSec network name
      # Or remove 'external: true' below to create a new network
      - crowdsec-net

volumes:
  abuseipdb-state:
    driver: local

networks:
  crowdsec-net:
    # If using an existing CrowdSec network, set external: true
    # and update the network name above to match
    external: true
    # If creating a new network, remove 'external: true' and uncomment below:
    # driver: bridge
